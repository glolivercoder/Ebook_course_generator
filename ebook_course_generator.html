<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de E-books e Cursos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            text-align: center;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            padding: 12px 24px;
            margin: 0 5px;
            border: none;
            background: transparent;
            color: #666;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none !important;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.3s ease;
        }
        
        /* CSS adicional para debug */
        .tab-content[style*="display: block"] {
            display: block !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .chapter-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .chapter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 8px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pending {
            background-color: #ffd700;
        }

        .status-generating {
            background-color: #4285f4;
        }

        .status-completed {
            background-color: #34a853;
        }

        .status-error {
            background-color: #ea4335;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìö Gerador de E-books e Cursos</h1>
            <p>Crie conte√∫do educacional completo com intelig√™ncia artificial</p>
            <div style="margin: 10px 0; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 5px;">
                <strong>üß™ TESTES DE DEBUG:</strong><br>
                <button onclick="alert('JavaScript funcionando!'); console.log('Teste JS OK');" style="background: #ff6b00; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px;">JS OK?</button>
                <button onclick="showTab('chapters'); console.log('Teste showTab chamado');" style="background: #007cba; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px;">‚Üí Cap√≠tulos</button>
                <button onclick="showTab('settings'); console.log('Teste settings');" style="background: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px;">‚Üí Config</button>
                <button onclick="console.log('Abas:', document.querySelectorAll('.tab-content').length);" style="background: #6c757d; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px;">Count Abas</button>
                <button onclick="debugTabs();" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 5px; margin: 5px;">üîç Debug</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('creator', this)">Criador</button>
            <button class="nav-tab" onclick="showTab('chapters', this)">Cap√≠tulos</button>
            <button class="nav-tab" onclick="showTab('visual-editor', this)">Editor Visual</button>
            <button class="nav-tab" onclick="showTab('settings', this)">Configura√ß√µes</button>
            <button class="nav-tab" onclick="showTab('export', this)">Exportar</button>
        </div>

        <!-- Tab: Criador -->
        <div id="creator" class="tab-content active">
            <h2>Criar Novo Projeto</h2>

            <div class="form-group">
                <label for="projectTitle">T√≠tulo do Projeto</label>
                <input type="text" id="projectTitle" class="form-control"
                    placeholder="Ex: Curso Completo de Marketing Digital">
            </div>

            <div class="form-group">
                <label for="projectType">Tipo de Projeto</label>
                <select id="projectType" class="form-control">
                    <option value="ebook">E-book</option>
                    <option value="course">Curso Online</option>
                    <option value="both">E-book + Curso</option>
                </select>
            </div>

            <div class="form-group">
                <label for="projectTopic">Tema Principal</label>
                <input type="text" id="projectTopic" class="form-control"
                    placeholder="Ex: Marketing Digital, Programa√ß√£o Python, Fotografia">
            </div>

            <div class="form-group">
                <label for="projectDescription">Descri√ß√£o Detalhada</label>
                <textarea id="projectDescription" class="form-control" rows="4"
                    placeholder="Descreva o conte√∫do, p√∫blico-alvo, objetivos de aprendizagem..."></textarea>
            </div>

            <div class="form-group">
                <label for="targetAudience">P√∫blico-Alvo</label>
                <select id="targetAudience" class="form-control">
                    <option value="beginner">Iniciante</option>
                    <option value="intermediate">Intermedi√°rio</option>
                    <option value="advanced">Avan√ßado</option>
                    <option value="mixed">Misto</option>
                </select>
            </div>

            <div class="form-group">
                <label for="chapterCount">N√∫mero de Cap√≠tulos</label>
                <input type="number" id="chapterCount" class="form-control" value="8" min="3" max="20">
            </div>

            <div class="form-group">
                <label for="researchUrls">URLs para Pesquisa (opcional)</label>
                <textarea id="researchUrls" class="form-control" rows="3"
                    placeholder="https://exemplo.com&#10;https://outro-site.com"></textarea>
            </div>

            <button class="btn" onclick="generateOutline()">
                <span id="generateIcon">üöÄ</span>
                <span id="generateText">Gerar Estrutura do Projeto</span>
            </button>

            <div id="projectProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressStatus">Iniciando...</div>
            </div>
        </div>

        <!-- Tab: Cap√≠tulos -->
        <div id="chapters" class="tab-content">
            <h2>Gerenciar Cap√≠tulos</h2>
            <div id="chaptersContainer">
                <p style="color: #666; text-align: center; padding: 40px;">
                    Primeiro crie um projeto na aba "Criador" para ver os cap√≠tulos aqui.
                </p>
            </div>
        </div>

        <!-- Tab: Editor Visual -->
        <div id="visual-editor" class="tab-content">
            <h2>Editor Visual - Estilo Kindle Create</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="initVisualEditor()">üé® Abrir Editor Visual</button>
                <button class="btn" onclick="loadChapterInEditor()">üìñ Carregar Cap√≠tulo no Editor</button>
            </div>
            <div id="visualEditorContainer"
                style="height: calc(100vh - 250px); border: 1px solid #ddd; border-radius: 12px;">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                    <div style="text-align: center;">
                        <h3>üé® Editor Visual</h3>
                        <p>Clique em "Abrir Editor Visual" para come√ßar a diagramar seu e-book</p>
                        <p style="font-size: 14px; margin-top: 10px;">
                            ‚ú® Interface similar ao Kindle Create<br>
                            üì± Templates otimizados para Kindle<br>
                            üñºÔ∏è Suporte a imagens e gr√°ficos<br>
                            üìÑ Exporta√ß√£o direta para KDP
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Configura√ß√µes -->
        <div id="settings" class="tab-content">
            <h2>Configura√ß√µes</h2>
            
            <div class="settings-grid">
            <div class="card">
                <h3>ü§ñ Configura√ß√£o de IA</h3>

                <div class="form-group">
                    <label for="aiProvider">Provedor de IA</label>
                    <select id="aiProvider" class="form-control">
                        <option value="openai">OpenAI (GPT-4)</option>
                        <option value="anthropic">Claude</option>
                        <option value="google">Google Gemini</option>
                        <option value="openrouter">OpenRouter</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="aiApiKey">Chave da API</label>
                    <input type="password" id="aiApiKey" class="form-control" placeholder="sua-chave-api-aqui">
                </div>

                <div class="form-group" id="openrouterModel" style="display: none;">
                    <label for="orModel">Modelo OpenRouter</label>
                    <select id="orModel" class="form-control">
                        <option value="openai/gpt-4">GPT-4</option>
                        <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                        <option value="google/gemini-pro">Gemini Pro</option>
                        <option value="meta-llama/llama-2-70b-chat">Llama 2 70B</option>
                    </select>
                </div>

                <button class="btn btn-small" onclick="testAIConnection()">Testar Conex√£o</button>
            </div>

            <div class="card">
                <h3>üß† Configura√ß√£o Agno (RAG)</h3>

                <div class="form-group">
                    <label for="agnoEndpoint">Endpoint Agno</label>
                    <input type="url" id="agnoEndpoint" class="form-control" placeholder="http://localhost:8000">
                </div>

                <div class="form-group">
                    <label for="agnoApiKey">Chave API Agno</label>
                    <input type="password" id="agnoApiKey" class="form-control" placeholder="sua-chave-agno">
                </div>

                <div class="form-group">
                    <label for="ragIndex">Nome do √çndice RAG</label>
                    <input type="text" id="ragIndex" class="form-control" value="ebook-projects">
                </div>

                <button class="btn btn-small" onclick="testAgnoConnection()">Testar Agno</button>
                <button class="btn btn-small" onclick="initializeRag()">Inicializar RAG</button>
            </div>

            <div class="card">
                <h3>üï∑Ô∏è Configura√ß√£o Crawl4AI</h3>

                <div class="form-group">
                    <label for="crawl4aiEndpoint">Endpoint Crawl4AI</label>
                    <input type="url" id="crawl4aiEndpoint" class="form-control" placeholder="http://localhost:8001">
                </div>

                <div class="form-group">
                    <label for="crawlDepth" class="tooltip"
                        data-tooltip="Profundidade m√°xima para rastreamento">Profundidade de Crawl</label>
                    <input type="number" id="crawlDepth" class="form-control" value="2" min="1" max="5">
                </div>

                <div class="form-group">
                    <label for="crawlDelay" class="tooltip" data-tooltip="Delay entre requests em millisegundos">Delay
                        entre Requests (ms)</label>
                    <input type="number" id="crawlDelay" class="form-control" value="1000" min="500" max="5000">
                </div>

                <button class="btn btn-small" onclick="testCrawl4aiConnection()">Testar Crawl4AI</button>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Configura√ß√µes Gerais</h3>

                <div class="form-group">
                    <label for="maxTokens" class="tooltip" data-tooltip="M√°ximo de tokens por requisi√ß√£o de IA">Max
                        Tokens por Requisi√ß√£o</label>
                    <input type="number" id="maxTokens" class="form-control" value="4000" min="1000" max="8000">
                </div>

                <div class="form-group">
                    <label for="temperature" class="tooltip" data-tooltip="Criatividade da IA (0.0 - 1.0)">Temperatura
                        da IA</label>
                    <input type="number" id="temperature" class="form-control" value="0.7" min="0" max="1" step="0.1">
                </div>

                <div class="form-group">
                    <label for="language">Idioma do Conte√∫do</label>
                    <select id="language" class="form-control">
                        <option value="pt">Portugu√™s</option>
                        <option value="en">Ingl√™s</option>
                        <option value="es">Espanhol</option>
                    </select>
                </div>

                <button class="btn btn-small" onclick="saveSettings()">Salvar Configura√ß√µes</button>
                <button class="btn btn-small" onclick="loadSettings()">Carregar Configura√ß√µes</button>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>üìä Status do Sistema</h3>
            <div class="log-container" id="systemLogs">
                Sistema inicializado...<br>
                Aguardando configura√ß√µes...
            </div>
        </div>

        <!-- Tab: Exportar -->
    <div id="export" class="tab-content">
        <h2>Exportar Projeto</h2>

        <div class="grid">
            <div class="card">
                <h3>üìÑ Formatos de E-book</h3>
                <button class="btn btn-small" onclick="exportProject('pdf')">Exportar PDF</button>
                <button class="btn btn-small" onclick="exportProject('epub')">Exportar EPUB</button>
                <button class="btn btn-small" onclick="exportProject('docx')">Exportar DOCX</button>
                <button class="btn btn-small" onclick="exportProject('kindle')"
                    style="background: linear-gradient(135deg, #ff9500, #ff6b00); color: white;">
                    üì± Exportar Kindle
                </button>
            </div>

            <div class="card">
                <h3>üéì Formatos de Curso</h3>
                <button class="btn btn-small" onclick="exportProject('scorm')">Pacote SCORM</button>
                <button class="btn btn-small" onclick="exportProject('html')">Site HTML</button>
                <button class="btn btn-small" onclick="exportProject('json')">JSON (API)</button>
            </div>

            <div class="card">
                <h3>‚òÅÔ∏è Plataformas</h3>
                <button class="btn btn-small" onclick="exportToPlatform('lovble')">Enviar para Lovble</button>
                <button class="btn btn-small" onclick="exportToPlatform('cursor')">Enviar para Cursor</button>
                <button class="btn btn-small" onclick="exportToPlatform('custom')">Plataforma Personalizada</button>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>‚ö° Preview do Projeto</h3>
            <div id="projectPreview" style="min-height: 200px; background: #f8f9fa; border-radius: 8px; padding: 20px;">
                <p style="color: #666; text-align: center;">Nenhum projeto carregado para preview</p>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Estado global da aplica√ß√£o
        let currentProject = null;
        let projectChapters = [];
        let systemConfig = {
            ai: { provider: 'openai', apiKey: '', model: 'gpt-4' },
            agno: { endpoint: 'http://localhost:8000', apiKey: '', index: 'ebook-projects' },
            crawl4ai: { endpoint: 'http://localhost:8001', depth: 2, delay: 1000 },
            general: { maxTokens: 4000, temperature: 0.7, language: 'pt' }
        };

        // Navega√ß√£o entre tabs - Vers√£o Simplificada
        function showTab(tabName, element) {
            console.log('üîÑ showTab chamado:', tabName);
            
            try {
                // 1. Esconder todas as abas
                const allTabs = document.querySelectorAll('.tab-content');
                console.log('üìä Total de abas encontradas:', allTabs.length);
                
                allTabs.forEach(tab => {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                });
                
                // 2. Desativar todos os bot√µes
                const allButtons = document.querySelectorAll('.nav-tab');
                allButtons.forEach(btn => btn.classList.remove('active'));
                
                // 3. Mostrar a aba selecionada
                const targetTab = document.getElementById(tabName);
                console.log('üéØ Aba alvo:', tabName, '‚Üí', targetTab);
                
                if (targetTab) {
                    targetTab.style.display = 'block';
                    targetTab.classList.add('active');
                    console.log('‚úÖ Aba mostrada:', tabName);
                } else {
                    console.error('‚ùå Aba n√£o encontrada:', tabName);
                    return;
                }
                
                // 4. Ativar o bot√£o clicado
                if (element) {
                    element.classList.add('active');
                    console.log('‚úÖ Bot√£o ativado');
                } else {
                    // Fallback: encontrar o bot√£o
                    const buttons = document.querySelectorAll('.nav-tab');
                    const tabNames = ['creator', 'chapters', 'visual-editor', 'settings', 'export'];
                    const index = tabNames.indexOf(tabName);
                    if (index >= 0 && buttons[index]) {
                        buttons[index].classList.add('active');
                        console.log('‚úÖ Bot√£o ativado via fallback');
                    }
                }
                
                console.log('üéâ Troca de aba conclu√≠da:', tabName);
                
            } catch (error) {
                console.error('‚ùå Erro na fun√ß√£o showTab:', error);
            }
        }

        // Fun√ß√£o para gerar a estrutura do projeto
        async function generateOutline() {
            const title = document.getElementById('projectTitle').value;
            const type = document.getElementById('projectType').value;
            const topic = document.getElementById('projectTopic').value;
            const description = document.getElementById('projectDescription').value;
            const audience = document.getElementById('targetAudience').value;
            const chapterCount = parseInt(document.getElementById('chapterCount').value);
            const researchUrls = document.getElementById('researchUrls').value.split('\n').filter(url => url.trim());

            if (!title || !topic || !description) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Atualizar UI
            document.getElementById('generateIcon').innerHTML = '<div class="loading"></div>';
            document.getElementById('generateText').textContent = 'Gerando...';
            document.getElementById('projectProgress').style.display = 'block';

            try {
                // 1. Realizar pesquisa web se URLs foram fornecidas
                let researchData = '';
                if (researchUrls.length > 0) {
                    updateProgress(10, 'Coletando dados de pesquisa...');
                    researchData = await performWebScraping(researchUrls);
                }

                // 2. Gerar estrutura com IA
                updateProgress(30, 'Gerando estrutura do projeto...');
                const outline = await generateProjectOutline(title, type, topic, description, audience, chapterCount, researchData);

                // 3. Salvar no RAG
                updateProgress(60, 'Salvando no sistema de conhecimento...');
                await saveToRAG(outline);

                // 4. Atualizar interface
                updateProgress(90, 'Finalizando...');
                currentProject = outline;
                projectChapters = outline.chapters;
                updateChaptersUI();

                updateProgress(100, 'Projeto criado com sucesso!');

                // Resetar bot√£o ap√≥s 2 segundos
                setTimeout(() => {
                    document.getElementById('generateIcon').textContent = 'üöÄ';
                    document.getElementById('generateText').textContent = 'Gerar Estrutura do Projeto';
                    document.getElementById('projectProgress').style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Erro ao gerar projeto:', error);
                updateProgress(0, 'Erro: ' + error.message);
                logToSystem(`ERRO: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o para atualizar progresso
        function updateProgress(percentage, status) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressStatus').textContent = status;
        }

        // Fun√ß√£o para realizar web scraping
        async function performWebScraping(urls) {
            logToSystem('Iniciando web scraping...', 'info');

            // Simula√ß√£o da integra√ß√£o com Crawl4AI
            const crawlResults = [];

            for (const url of urls) {
                try {
                    logToSystem(`Crawling: ${url}`, 'info');

                    // Aqui seria a integra√ß√£o real com Crawl4AI
                    const result = await fetch(`${systemConfig.crawl4ai.endpoint}/crawl`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: url,
                            depth: systemConfig.crawl4ai.depth,
                            delay: systemConfig.crawl4ai.delay
                        })
                    });

                    const data = await result.json();
                    crawlResults.push(data);

                } catch (error) {
                    logToSystem(`Erro no crawling de ${url}: ${error.message}`, 'error');
                }
            }

            return crawlResults;
        }

        // Fun√ß√£o para gerar estrutura do projeto com IA
        async function generateProjectOutline(title, type, topic, description, audience, chapterCount, researchData) {
            logToSystem('Gerando estrutura do projeto com IA...', 'info');

            const prompt = `Crie uma estrutura detalhada para um ${type} sobre "${topic}".

Detalhes do projeto:
- T√≠tulo: ${title}
- Descri√ß√£o: ${description}
- P√∫blico-alvo: ${audience}
- N√∫mero de cap√≠tulos: ${chapterCount}

${researchData ? `Dados de pesquisa coletados:\n${JSON.stringify(researchData, null, 2)}` : ''}

Gere uma estrutura JSON com:
1. Informa√ß√µes gerais do projeto
2. Lista de cap√≠tulos com t√≠tulo, descri√ß√£o, t√≥picos principais e objetivos de aprendizagem
3. Sugest√µes de imagens/gr√°ficos para cada cap√≠tulo
4. Pontos de intera√ß√£o para cada cap√≠tulo

Formato esperado:
{
  "title": "t√≠tulo",
  "type": "tipo",
  "description": "descri√ß√£o",
  "audience": "p√∫blico",
  "chapters": [
    {
      "id": 1,
      "title": "T√≠tulo do Cap√≠tulo",
      "description": "Descri√ß√£o detalhada",
      "topics": ["t√≥pico1", "t√≥pico2"],
      "learningObjectives": ["objetivo1", "objetivo2"],
      "suggestedMedia": {
        "images": ["descri√ß√£o da imagem"],
        "charts": ["tipo de gr√°fico sugerido"],
        "interactions": ["tipo de intera√ß√£o"]
      },
      "status": "pending"
    }
  ]
}`;

            // Aqui seria a integra√ß√£o real com a API de IA escolhida
            const aiResponse = await callAIProvider(prompt);
            return JSON.parse(aiResponse);
        }

        // Fun√ß√£o para chamar o provedor de IA
        async function callAIProvider(prompt) {
            const provider = systemConfig.ai.provider;
            const apiKey = systemConfig.ai.apiKey;

            if (!apiKey) {
                throw new Error('Chave da API n√£o configurada. Configure nas Configura√ß√µes.');
            }

            let endpoint, headers, body;

            switch (provider) {
                case 'openai':
                    endpoint = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    body = {
                        model: 'gpt-4',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: systemConfig.general.maxTokens,
                        temperature: systemConfig.general.temperature
                    };
                    break;

                case 'anthropic':
                    endpoint = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    body = {
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: systemConfig.general.maxTokens,
                        messages: [{ role: 'user', content: prompt }]
                    };
                    break;

                case 'openrouter':
                    endpoint = 'https://openrouter.ai/api/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin
                    };
                    body = {
                        model: systemConfig.ai.model,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: systemConfig.general.maxTokens,
                        temperature: systemConfig.general.temperature
                    };
                    break;

                default:
                    throw new Error(`Provedor ${provider} n√£o suportado`);
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers,
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();

            // Extrair conte√∫do baseado no provedor
            switch (provider) {
                case 'openai':
                case 'openrouter':
                    return data.choices[0].message.content;
                case 'anthropic':
                    return data.content[0].text;
                default:
                    throw new Error('Formato de resposta desconhecido');
            }
        }

        // Fun√ß√£o para salvar no RAG (Agno)
        async function saveToRAG(projectData) {
            logToSystem('Salvando projeto no sistema RAG...', 'info');

            try {
                const response = await fetch('/api/rag/save-project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint: systemConfig.agno.endpoint,
                        apiKey: systemConfig.agno.apiKey,
                        indexName: systemConfig.agno.index,
                        project: projectData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logToSystem('Projeto salvo no RAG com sucesso!', 'success');
                } else {
                    throw new Error(result.error || 'Erro desconhecido no RAG');
                }

            } catch (error) {
                logToSystem(`Erro ao salvar no RAG: ${error.message}`, 'error');
                throw error;
            }
        }

        // Fun√ß√£o para atualizar interface dos cap√≠tulos
        function updateChaptersUI() {
            const container = document.getElementById('chaptersContainer');

            if (!currentProject || !projectChapters.length) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Nenhum projeto carregado.</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>${currentProject.title}</h3>
                    <p style="color: #666;">${currentProject.description}</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <span class="status-indicator status-completed"></span>
                        <span>${projectChapters.filter(c => c.status === 'completed').length} de ${projectChapters.length} cap√≠tulos conclu√≠dos</span>
                    </div>
                </div>
                
                ${projectChapters.map((chapter, index) => `
                    <div class="chapter-item">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <h4>
                                    <span class="status-indicator status-${chapter.status}"></span>
                                    Cap√≠tulo ${index + 1}: ${chapter.title}
                                </h4>
                                <p style="color: #666; margin: 10px 0;">${chapter.description}</p>
                                
                                ${chapter.topics ? `
                                    <div style="margin: 10px 0;">
                                        <strong>T√≥picos:</strong> ${chapter.topics.join(', ')}
                                    </div>
                                ` : ''}
                                
                                ${chapter.learningObjectives ? `
                                    <div style="margin: 10px 0;">
                                        <strong>Objetivos:</strong>
                                        <ul style="margin: 5px 0 0 20px;">
                                            ${chapter.learningObjectives.map(obj => `<li>${obj}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${chapter.content ? `
                                    <div style="margin: 10px 0;">
                                        <strong>Conte√∫do:</strong> ${chapter.content.substring(0, 200)}...
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="chapter-actions">
                            <button class="btn btn-small" onclick="generateChapter(${chapter.id})" 
                                    ${chapter.status === 'generating' ? 'disabled' : ''}>
                                ${chapter.status === 'generating' ? 'Gerando...' : 'Gerar Conte√∫do'}
                            </button>
                            <button class="btn btn-small" onclick="addMediaToChapter(${chapter.id})">
                                Adicionar M√≠dia
                            </button>
                            <button class="btn btn-small" onclick="editChapter(${chapter.id})">
                                Editar
                            </button>
                            ${chapter.content ? `
                                <button class="btn btn-small" onclick="previewChapter(${chapter.id})">
                                    Visualizar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Fun√ß√£o para gerar conte√∫do de um cap√≠tulo
        async function generateChapter(chapterId) {
            if (!currentProject) {
                alert('Nenhum projeto carregado.');
                return;
            }

            const chapter = projectChapters.find(c => c.id === chapterId);
            if (!chapter) {
                alert('Cap√≠tulo n√£o encontrado.');
                return;
            }

            // Atualizar status
            chapter.status = 'generating';
            updateChaptersUI();

            try {
                logToSystem(`Gerando conte√∫do para: ${chapter.title}`, 'info');

                const response = await fetch(`/api/projects/${currentProject.id}/chapters/${chapterId}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        aiConfig: {
                            provider: systemConfig.ai.provider,
                            apiKey: systemConfig.ai.apiKey,
                            model: systemConfig.ai.model,
                            maxTokens: systemConfig.general.maxTokens,
                            temperature: systemConfig.general.temperature
                        },
                        ragConfig: {
                            endpoint: systemConfig.agno.endpoint,
                            apiKey: systemConfig.agno.apiKey,
                            indexName: systemConfig.agno.index
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Atualizar cap√≠tulo local
                    Object.assign(chapter, result.chapter);
                    updateChaptersUI();
                    logToSystem(`Cap√≠tulo "${chapter.title}" gerado com sucesso!`, 'success');
                } else {
                    throw new Error(result.error || 'Erro na gera√ß√£o do cap√≠tulo');
                }

            } catch (error) {
                console.error('Erro ao gerar cap√≠tulo:', error);
                chapter.status = 'error';
                updateChaptersUI();
                logToSystem(`Erro ao gerar cap√≠tulo: ${error.message}`, 'error');
                alert('Erro ao gerar cap√≠tulo: ' + error.message);
            }
        }

        // Fun√ß√£o para adicionar m√≠dia a um cap√≠tulo
        function addMediaToChapter(chapterId) {
            const chapter = projectChapters.find(c => c.id === chapterId);
            if (!chapter) return;

            const mediaType = prompt('Tipo de m√≠dia (image/chart/video/audio):', 'image');
            if (!mediaType) return;

            const mediaUrl = prompt('URL da m√≠dia ou descri√ß√£o para gera√ß√£o:');
            if (!mediaUrl) return;

            const description = prompt('Descri√ß√£o da m√≠dia:');

            // Aqui voc√™ pode implementar upload de arquivo ou gera√ß√£o de m√≠dia
            fetch(`/api/projects/${currentProject.id}/chapters/${chapterId}/media`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: mediaType,
                    url: mediaUrl,
                    description: description
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        logToSystem('M√≠dia adicionada com sucesso!', 'success');
                        // Atualizar interface se necess√°rio
                    } else {
                        throw new Error(result.error);
                    }
                })
                .catch(error => {
                    console.error('Erro ao adicionar m√≠dia:', error);
                    alert('Erro ao adicionar m√≠dia: ' + error.message);
                });
        }

        // Fun√ß√£o para editar cap√≠tulo
        function editChapter(chapterId) {
            const chapter = projectChapters.find(c => c.id === chapterId);
            if (!chapter) return;

            // Implementar modal de edi√ß√£o ou redirecionar para p√°gina de edi√ß√£o
            alert('Funcionalidade de edi√ß√£o ser√° implementada em breve!');
        }

        // Fun√ß√£o para visualizar cap√≠tulo
        function previewChapter(chapterId) {
            const chapter = projectChapters.find(c => c.id === chapterId);
            if (!chapter || !chapter.content) return;

            // Criar modal de preview
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                    ">&times;</button>
                    
                    <h2>${chapter.title}</h2>
                    <div style="color: #666; margin-bottom: 20px;">${chapter.description}</div>
                    <div style="line-height: 1.6;">${convertMarkdownToHTML(chapter.content)}</div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Fun√ß√£o auxiliar para converter markdown para HTML
        function convertMarkdownToHTML(markdown) {
            return markdown
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
                .replace(/^\* (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                .replace(/<p><h/g, '<h')
                .replace(/<\/h([1-6])><\/p>/g, '</h$1>')
                .replace(/<p><ul>/g, '<ul>')
                .replace(/<\/ul><\/p>/g, '</ul>')
                .replace(/<p><blockquote>/g, '<blockquote>')
                .replace(/<\/blockquote><\/p>/g, '</blockquote>');
        }

        // Fun√ß√µes de configura√ß√£o
        async function testAIConnection() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value;
            const model = document.getElementById('orModel').value;

            if (!apiKey) {
                alert('Por favor, insira a chave da API.');
                return;
            }

            try {
                logToSystem('Testando conex√£o com IA...', 'info');

                const response = await fetch('/api/ai/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider,
                        apiKey,
                        model: provider === 'openrouter' ? model : undefined
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logToSystem('‚úÖ Conex√£o com IA estabelecida!', 'success');
                    alert('Conex√£o testada com sucesso!');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Erro no teste de IA:', error);
                logToSystem(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                alert('Erro na conex√£o: ' + error.message);
            }
        }

        async function testAgnoConnection() {
            const endpoint = document.getElementById('agnoEndpoint').value;
            const apiKey = document.getElementById('agnoApiKey').value;

            try {
                logToSystem('Testando conex√£o com Agno...', 'info');

                const response = await fetch('/api/rag/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint,
                        apiKey
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logToSystem('‚úÖ Conex√£o com Agno estabelecida!', 'success');
                    alert('Conex√£o testada com sucesso!');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Erro no teste do Agno:', error);
                logToSystem(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                alert('Erro na conex√£o: ' + error.message);
            }
        }

        async function testCrawl4aiConnection() {
            const endpoint = document.getElementById('crawl4aiEndpoint').value;

            try {
                logToSystem('Testando conex√£o com Crawl4AI...', 'info');

                const response = await fetch('/api/crawl/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logToSystem('‚úÖ Conex√£o com Crawl4AI estabelecida!', 'success');
                    alert('Conex√£o testada com sucesso!');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Erro no teste do Crawl4AI:', error);
                logToSystem(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                alert('Erro na conex√£o: ' + error.message);
            }
        }

        async function initializeRag() {
            const endpoint = document.getElementById('agnoEndpoint').value;
            const apiKey = document.getElementById('agnoApiKey').value;
            const indexName = document.getElementById('ragIndex').value;

            try {
                logToSystem('Inicializando RAG...', 'info');

                const response = await fetch('/api/rag/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint,
                        apiKey,
                        indexName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logToSystem('‚úÖ RAG inicializado com sucesso!', 'success');
                    alert('RAG inicializado com sucesso!');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Erro na inicializa√ß√£o do RAG:', error);
                logToSystem(`‚ùå Erro na inicializa√ß√£o: ${error.message}`, 'error');
                alert('Erro na inicializa√ß√£o: ' + error.message);
            }
        }

        // Fun√ß√µes de configura√ß√£o
        function saveSettings() {
            const settings = {
                ai: {
                    provider: document.getElementById('aiProvider').value,
                    apiKey: document.getElementById('aiApiKey').value,
                    model: document.getElementById('orModel').value
                },
                agno: {
                    endpoint: document.getElementById('agnoEndpoint').value,
                    apiKey: document.getElementById('agnoApiKey').value,
                    index: document.getElementById('ragIndex').value
                },
                crawl4ai: {
                    endpoint: document.getElementById('crawl4aiEndpoint').value,
                    depth: parseInt(document.getElementById('crawlDepth').value),
                    delay: parseInt(document.getElementById('crawlDelay').value)
                },
                general: {
                    maxTokens: parseInt(document.getElementById('maxTokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    language: document.getElementById('language').value
                }
            };

            localStorage.setItem('ebookGeneratorSettings', JSON.stringify(settings));
            systemConfig = settings;

            logToSystem('Configura√ß√µes salvas!', 'success');
            alert('Configura√ß√µes salvas com sucesso!');
        }

        function loadSettings() {
            const saved = localStorage.getItem('ebookGeneratorSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                systemConfig = settings;

                // Atualizar interface
                document.getElementById('aiProvider').value = settings.ai.provider;
                document.getElementById('aiApiKey').value = settings.ai.apiKey;
                document.getElementById('orModel').value = settings.ai.model;

                document.getElementById('agnoEndpoint').value = settings.agno.endpoint;
                document.getElementById('agnoApiKey').value = settings.agno.apiKey;
                document.getElementById('ragIndex').value = settings.agno.index;

                document.getElementById('crawl4aiEndpoint').value = settings.crawl4ai.endpoint;
                document.getElementById('crawlDepth').value = settings.crawl4ai.depth;
                document.getElementById('crawlDelay').value = settings.crawl4ai.delay;

                document.getElementById('maxTokens').value = settings.general.maxTokens;
                document.getElementById('temperature').value = settings.general.temperature;
                document.getElementById('language').value = settings.general.language;

                logToSystem('Configura√ß√µes carregadas!', 'success');
            }
        }

        // Fun√ß√£o para log do sistema
        function logToSystem(message, type = 'info') {
            const logContainer = document.getElementById('systemLogs');
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'info': '#00ff00',
                'success': '#00ff00',
                'error': '#ff0000',
                'warning': '#ffff00'
            }[type] || '#00ff00';

            logContainer.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Fun√ß√µes de exporta√ß√£o
        async function exportProject(format) {
            if (!currentProject) {
                alert('Nenhum projeto carregado para exportar.');
                return;
            }

            try {
                logToSystem(`Exportando projeto como ${format.toUpperCase()}...`, 'info');

                const response = await fetch(`/api/export/${currentProject.id}/${format}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        options: {
                            author: 'Gerador de E-books',
                            includeImages: true,
                            includeCharts: true
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    logToSystem(`‚úÖ Projeto exportado como ${format.toUpperCase()}!`, 'success');

                    // Criar link de download
                    const link = document.createElement('a');
                    link.href = result.downloadUrl;
                    link.download = result.filename;
                    link.click();

                    alert('Projeto exportado com sucesso! Download iniciado.');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Erro na exporta√ß√£o:', error);
                logToSystem(`‚ùå Erro na exporta√ß√£o: ${error.message}`, 'error');
                alert('Erro na exporta√ß√£o: ' + error.message);
            }
        }

        function exportToPlatform(platform) {
            alert(`Exporta√ß√£o para ${platform} ser√° implementada em breve!`);
        }

        // Event listeners
        document.getElementById('aiProvider').addEventListener('change', function () {
            const openrouterModel = document.getElementById('openrouterModel');
            if (this.value === 'openrouter') {
                openrouterModel.style.display = 'block';
            } else {
                openrouterModel.style.display = 'none';
            }
        });

        // Fun√ß√£o para verificar se todas as abas existem
        function checkTabs() {
            const tabs = ['creator', 'chapters', 'visual-editor', 'settings', 'export'];
            console.log('üîç Verificando abas...');
            tabs.forEach(tabName => {
                const tabContent = document.getElementById(tabName);
                if (tabContent) {
                    console.log(`‚úÖ Tab ${tabName} encontrada`);
                } else {
                    console.error(`‚ùå Tab ${tabName} N√ÉO encontrada`);
                }
            });
        }

        // Fun√ß√£o para inicializar as abas
        function initializeTabs() {
            console.log('üöÄ Inicializando sistema de abas...');
            
            // Garantir que a primeira aba esteja ativa
            const firstTab = document.getElementById('creator');
            const firstButton = document.querySelector('.nav-tab');
            
            if (firstTab && firstButton) {
                // Limpar todas as classes active
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                
                // Ativar a primeira aba
                firstButton.classList.add('active');
                firstTab.classList.add('active');
                firstTab.style.display = 'block';
                
                console.log('‚úÖ Primeira aba ativada');
            } else {
                console.error('‚ùå N√£o foi poss√≠vel inicializar as abas');
            }
        }

        // Fun√ß√£o de debug para mostrar estado das abas
        function debugTabs() {
            console.log('üîç DEBUG - Estado das abas:');
            
            const tabs = ['creator', 'chapters', 'visual-editor', 'settings', 'export'];
            tabs.forEach(tabName => {
                const element = document.getElementById(tabName);
                if (element) {
                    const hasActive = element.classList.contains('active');
                    const display = window.getComputedStyle(element).display;
                    const visibility = window.getComputedStyle(element).visibility;
                    console.log(`üìã ${tabName}:`, {
                        exists: true,
                        hasActive,
                        display,
                        visibility,
                        classes: Array.from(element.classList)
                    });
                } else {
                    console.log(`‚ùå ${tabName}: n√£o encontrada`);
                }
            });
            
            // Verificar bot√µes
            const buttons = document.querySelectorAll('.nav-tab');
            console.log('üîò Bot√µes encontrados:', buttons.length);
            buttons.forEach((btn, index) => {
                console.log(`üîò Bot√£o ${index}:`, {
                    text: btn.textContent,
                    hasActive: btn.classList.contains('active'),
                    onclick: btn.getAttribute('onclick')
                });
            });
        }

        // Tornar fun√ß√£o dispon√≠vel globalmente para teste
        window.debugTabs = debugTabs;



        // Carregar configura√ß√µes ao inicializar
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ DOM carregado, inicializando sistema...');
            
            // Verificar abas
            checkTabs();
            
            // Inicializar sistema de abas
            initializeTabs();
            
            // Adicionar event listeners alternativos para os bot√µes
            document.querySelectorAll('.nav-tab').forEach((button, index) => {
                const tabNames = ['creator', 'chapters', 'visual-editor', 'settings', 'export'];
                const tabName = tabNames[index];
                
                button.addEventListener('click', function(e) {
                    console.log('üñ±Ô∏è Clique detectado via addEventListener:', tabName);
                    showTab(tabName, this);
                });
            });
            
            loadSettings();
            logToSystem('Sistema inicializado!', 'success');
        });
        topic: projectData.topic,
            created_at: new Date().toISOString()
                        }
                    })
                });

        if (!response.ok) {
            throw new Error(`Erro ao salvar no RAG: ${response.status}`);
        }

        logToSystem('Projeto salvo no RAG com sucesso', 'success');
        return await response.json();

            } catch (error) {
            logToSystem(`Erro no RAG: ${error.message}`, 'error');
            throw error;
        }
        }

        // Fun√ß√£o para atualizar a UI dos cap√≠tulos
        function updateChaptersUI() {
            const container = document.getElementById('chaptersContainer');

            if (!currentProject || !projectChapters.length) {
                container.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 40px;">
                        Primeiro crie um projeto na aba "Criador" para ver os cap√≠tulos aqui.
                    </p>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h3>${currentProject.title}</h3>
                        <p style="color: #666;">${projectChapters.length} cap√≠tulos ‚Ä¢ ${currentProject.audience}</p>
                    </div>
                    <div>
                        <button class="btn btn-small" onclick="generateAllChapters()">
                            üöÄ Gerar Todos os Cap√≠tulos
                        </button>
                        <button class="btn btn-small" onclick="addNewChapter()">
                            ‚ûï Adicionar Cap√≠tulo
                        </button>
                    </div>
                </div>

                <div id="chaptersProgressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="chaptersProgressFill"></div>
                    </div>
                    <div id="chaptersProgressStatus">Preparando...</div>
                </div>

                <div id="chaptersList">
                    ${projectChapters.map((chapter, index) => createChapterHTML(chapter, index)).join('')}
                </div>
            `;
        }

        // Fun√ß√£o para criar HTML de um cap√≠tulo
        function createChapterHTML(chapter, index) {
            const statusIcons = {
                pending: '‚è≥',
                generating: 'üîÑ',
                completed: '‚úÖ',
                error: '‚ùå',
                editing: '‚úèÔ∏è'
            };

            return `
                <div class="chapter-item" id="chapter_${chapter.id}">
                    <div style="display: flex; justify-content: between; align-items: flex-start; gap: 20px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <span class="status-indicator status-${chapter.status}"></span>
                                <h4 style="margin: 0;">${statusIcons[chapter.status]} Cap√≠tulo ${chapter.id}: ${chapter.title}</h4>
                            </div>
                            
                            <p style="color: #666; margin-bottom: 15px;">${chapter.description}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong>T√≥picos:</strong>
                                    <ul style="margin: 5px 0 0 20px; color: #666;">
                                        ${chapter.topics.map(topic => `<li>${topic}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <strong>Objetivos:</strong>
                                    <ul style="margin: 5px 0 0 20px; color: #666;">
                                        ${chapter.learningObjectives.map(obj => `<li>${obj}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>

                            ${chapter.content ? `
                                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="max-height: 150px; overflow-y: auto;">
                                        ${chapter.content.substring(0, 500)}${chapter.content.length > 500 ? '...' : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div style="min-width: 200px;">
                            <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);">
                                <h5 style="margin: 0 0 10px 0; color: #333;">M√≠dia Sugerida</h5>
                                
                                <div style="margin-bottom: 10px;">
                                    <strong style="font-size: 12px;">üì∏ Imagens:</strong>
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                        ${chapter.suggestedMedia.images.map(img => `‚Ä¢ ${img}`).join('<br>')}
                                    </div>
                                </div>

                                <div style="margin-bottom: 10px;">
                                    <strong style="font-size: 12px;">üìä Gr√°ficos:</strong>
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                        ${chapter.suggestedMedia.charts.map(chart => `‚Ä¢ ${chart}`).join('<br>')}
                                    </div>
                                </div>

                                <div>
                                    <strong style="font-size: 12px;">üéØ Intera√ß√µes:</strong>
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                        ${chapter.suggestedMedia.interactions.map(int => `‚Ä¢ ${int}`).join('<br>')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chapter-actions">
                        <button class="btn btn-small" onclick="generateChapterContent(${chapter.id})" 
                                ${chapter.status === 'generating' ? 'disabled' : ''}>
                            ${chapter.status === 'generating' ? 'üîÑ Gerando...' : 'üìù Gerar Conte√∫do'}
                        </button>
                        
                        <button class="btn btn-small" onclick="editChapter(${chapter.id})" 
                                ${!chapter.content ? 'disabled' : ''}>
                            ‚úèÔ∏è Editar
                        </button>
                        
                        <button class="btn btn-small" onclick="addMediaToChapter(${chapter.id})">
                            üñºÔ∏è Adicionar M√≠dia
                        </button>
                        
                        <button class="btn btn-small" onclick="generateChartForChapter(${chapter.id})">
                            üìä Gerar Gr√°fico
                        </button>
                        
                        <button class="btn btn-small" onclick="previewChapter(${chapter.id})" 
                                ${!chapter.content ? 'disabled' : ''}>
                            üëÅÔ∏è Preview
                        </button>
                        
                        <button class="btn btn-small" onclick="deleteChapter(${chapter.id})" 
                                style="background: #e74c3c;">
                            üóëÔ∏è Deletar
                        </button>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para gerar conte√∫do de um cap√≠tulo espec√≠fico
        async function generateChapterContent(chapterId) {
            const chapterIndex = projectChapters.findIndex(ch => ch.id === chapterId);
            if (chapterIndex === -1) return;

            const chapter = projectChapters[chapterIndex];
            chapter.status = 'generating';
            updateChaptersUI();

            try {
                logToSystem(`Gerando conte√∫do do cap√≠tulo ${chapterId}...`, 'info');

                // Buscar contexto no RAG
                const ragContext = await searchInRAG(chapter.title + ' ' + chapter.topics.join(' '));

                // Gerar prompt contextualizado
                const prompt = `Escreva o conte√∫do completo para o cap√≠tulo "${chapter.title}" de um ${currentProject.type} sobre "${currentProject.topic}".

Descri√ß√£o do cap√≠tulo: ${chapter.description}

T√≥picos a abordar:
${chapter.topics.map(topic => `- ${topic}`).join('\n')}

Objetivos de aprendizagem:
${chapter.learningObjectives.map(obj => `- ${obj}`).join('\n')}

P√∫blico-alvo: ${currentProject.audience}

${ragContext ? `Contexto adicional do conhecimento base:\n${ragContext}\n` : ''}

Instru√ß√µes:
1. Escreva um conte√∫do detalhado e did√°tico
2. Use linguagem adequada para o n√≠vel ${currentProject.audience}
3. Inclua exemplos pr√°ticos quando apropriado
4. Estruture com subt√≠tulos e par√°grafos bem organizados
5. Indique pontos onde imagens ou gr√°ficos seriam √∫teis usando [IMAGEM: descri√ß√£o] ou [GR√ÅFICO: tipo]
6. Adicione pontos de intera√ß√£o usando [INTERA√á√ÉO: tipo de atividade]
7. Mantenha entre 1500-3000 palavras dependendo da complexidade

Responda apenas com o conte√∫do do cap√≠tulo em formato markdown.`;

                const content = await callAIProvider(prompt);

                // Salvar conte√∫do
                chapter.content = content;
                chapter.status = 'completed';
                chapter.generatedAt = new Date().toISOString();

                // Atualizar no RAG
                await updateChapterInRAG(chapter);

                logToSystem(`Cap√≠tulo ${chapterId} gerado com sucesso`, 'success');
                updateChaptersUI();

            } catch (error) {
                chapter.status = 'error';
                chapter.error = error.message;
                logToSystem(`Erro ao gerar cap√≠tulo ${chapterId}: ${error.message}`, 'error');
                updateChaptersUI();
            }
        }

        // Fun√ß√£o para gerar todos os cap√≠tulos
        async function generateAllChapters() {
            const pendingChapters = projectChapters.filter(ch => ch.status === 'pending' || ch.status === 'error');

            if (pendingChapters.length === 0) {
                alert('Todos os cap√≠tulos j√° foram gerados!');
                return;
            }

            const progressContainer = document.getElementById('chaptersProgressContainer');
            const progressFill = document.getElementById('chaptersProgressFill');
            const progressStatus = document.getElementById('chaptersProgressStatus');

            progressContainer.style.display = 'block';

            for (let i = 0; i < pendingChapters.length; i++) {
                const chapter = pendingChapters[i];
                const progress = Math.round(((i + 1) / pendingChapters.length) * 100);

                progressFill.style.width = `${progress}%`;
                progressStatus.textContent = `Gerando cap√≠tulo ${chapter.id}: ${chapter.title} (${i + 1}/${pendingChapters.length})`;

                await generateChapterContent(chapter.id);

                // Delay entre cap√≠tulos para n√£o sobrecarregar a API
                if (i < pendingChapters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            progressContainer.style.display = 'none';
            logToSystem('Todos os cap√≠tulos foram gerados!', 'success');
        }

        // Fun√ß√£o para buscar contexto no RAG
        async function searchInRAG(query) {
            try {
                const ragEndpoint = systemConfig.agno.endpoint;
                const ragApiKey = systemConfig.agno.apiKey;
                const indexName = systemConfig.agno.index;

                const response = await fetch(`${ragEndpoint}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ragApiKey}`
                    },
                    body: JSON.stringify({
                        index: indexName,
                        query: query,
                        limit: 5,
                        include_metadata: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro na busca RAG: ${response.status}`);
                }

                const results = await response.json();
                return results.documents.map(doc => doc.content).join('\n\n');

            } catch (error) {
                logToSystem(`Erro na busca RAG: ${error.message}`, 'warning');
                return null;
            }
        }

        // Fun√ß√£o para atualizar cap√≠tulo no RAG
        async function updateChapterInRAG(chapter) {
            try {
                const ragEndpoint = systemConfig.agno.endpoint;
                const ragApiKey = systemConfig.agno.apiKey;
                const indexName = systemConfig.agno.index;

                await fetch(`${ragEndpoint}/documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ragApiKey}`
                    },
                    body: JSON.stringify({
                        index: indexName,
                        document_id: `chapter_${currentProject.title}_${chapter.id}`,
                        content: chapter.content,
                        metadata: {
                            type: 'chapter',
                            project_title: currentProject.title,
                            chapter_id: chapter.id,
                            chapter_title: chapter.title,
                            topics: chapter.topics,
                            status: chapter.status,
                            generated_at: chapter.generatedAt
                        }
                    })
                });

                logToSystem(`Cap√≠tulo ${chapter.id} salvo no RAG`, 'info');

            } catch (error) {
                logToSystem(`Erro ao salvar cap√≠tulo no RAG: ${error.message}`, 'warning');
            }
        }

        // Fun√ß√£o para adicionar novo cap√≠tulo
        function addNewChapter() {
            const newId = Math.max(...projectChapters.map(ch => ch.id)) + 1;
            const newChapter = {
                id: newId,
                title: `Novo Cap√≠tulo ${newId}`,
                description: 'Descri√ß√£o do cap√≠tulo a ser definida',
                topics: ['T√≥pico a definir'],
                learningObjectives: ['Objetivo a definir'],
                suggestedMedia: {
                    images: ['Imagem relevante ao tema'],
                    charts: ['Gr√°fico ou infogr√°fico'],
                    interactions: ['Exerc√≠cio pr√°tico']
                },
                status: 'pending'
            };

            projectChapters.push(newChapter);
            updateChaptersUI();

            // Automaticamente abrir para edi√ß√£o
            setTimeout(() => editChapter(newId), 100);
        }

        // Fun√ß√£o para editar cap√≠tulo
        function editChapter(chapterId) {
            const chapter = projectChapters.find(ch => ch.id === chapterId);
            if (!chapter) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3>Editar Cap√≠tulo ${chapter.id}</h3>
                    
                    <div class="form-group">
                        <label>T√≠tulo do Cap√≠tulo</label>
                        <input type="text" id="editTitle" class="form-control" value="${chapter.title}">
                    </div>

                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="editDescription" class="form-control" rows="3">${chapter.description}</textarea>
                    </div>

                    <div class="form-group">
                        <label>T√≥picos (um por linha)</label>
                        <textarea id="editTopics" class="form-control" rows="4">${chapter.topics.join('\n')}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Objetivos de Aprendizagem (um por linha)</label>
                        <textarea id="editObjectives" class="form-control" rows="4">${chapter.learningObjectives.join('\n')}</textarea>
                    </div>

                    ${chapter.content ? `
                        <div class="form-group">
                            <label>Conte√∫do do Cap√≠tulo</label>
                            <textarea id="editContent" class="form-control" rows="10">${chapter.content}</textarea>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="saveChapterEdit(${chapterId})">üíæ Salvar</button>
                        <button class="btn" onclick="closeModal()" style="background: #6c757d;">‚ùå Cancelar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        // Fun√ß√£o para salvar edi√ß√£o do cap√≠tulo
        function saveChapterEdit(chapterId) {
            const chapter = projectChapters.find(ch => ch.id === chapterId);
            if (!chapter) return;

            chapter.title = document.getElementById('editTitle').value;
            chapter.description = document.getElementById('editDescription').value;
            chapter.topics = document.getElementById('editTopics').value.split('\n').filter(t => t.trim());
            chapter.learningObjectives = document.getElementById('editObjectives').value.split('\n').filter(o => o.trim());

            if (document.getElementById('editContent')) {
                chapter.content = document.getElementById('editContent').value;
            }

            updateChaptersUI();
            closeModal();
            logToSystem(`Cap√≠tulo ${chapterId} editado com sucesso`, 'success');
        }

        // Fun√ß√£o para fechar modal
        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }

        // Fun√ß√£o para adicionar m√≠dia ao cap√≠tulo
        function addMediaToChapter(chapterId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%;">
                    <h3>Adicionar M√≠dia ao Cap√≠tulo ${chapterId}</h3>
                    
                    <div class="form-group">
                        <label>Tipo de M√≠dia</label>
                        <select id="mediaType" class="form-control">
                            <option value="image">Imagem</option>
                            <option value="chart">Gr√°fico/Dashboard</option>
                            <option value="interaction">Intera√ß√£o</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Upload de Arquivo ou Prompt para Gera√ß√£o</label>
                        <input type="file" id="mediaFile" class="form-control" accept="image/*">
                        <br>
                        <textarea id="mediaPrompt" class="form-control" rows="3" placeholder="Ou descreva a m√≠dia para gerar automaticamente..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Descri√ß√£o/Legenda</label>
                        <textarea id="mediaDescription" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Posi√ß√£o no Cap√≠tulo</label>
                        <select id="mediaPosition" class="form-control">
                            <option value="beginning">In√≠cio do cap√≠tulo</option>
                            <option value="middle">Meio do cap√≠tulo</option>
                            <option value="end">Final do cap√≠tulo</option>
                            <option value="custom">Posi√ß√£o personalizada</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="saveMediaToChapter(${chapterId})">üíæ Adicionar M√≠dia</button>
                        <button class="btn" onclick="closeModal()" style="background: #6c757d;">‚ùå Cancelar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        // Fun√ß√£o para salvar m√≠dia no cap√≠tulo
        function saveMediaToChapter(chapterId) {
            const chapter = projectChapters.find(ch => ch.id === chapterId);
            if (!chapter) return;

            const mediaType = document.getElementById('mediaType').value;
            const mediaFile = document.getElementById('mediaFile').files[0];
            const mediaPrompt = document.getElementById('mediaPrompt').value;
            const mediaDescription = document.getElementById('mediaDescription').value;
            const mediaPosition = document.getElementById('mediaPosition').value;

            if (!chapter.media) chapter.media = [];

            const mediaItem = {
                id: Date.now(),
                type: mediaType,
                description: mediaDescription,
                position: mediaPosition,
                createdAt: new Date().toISOString()
            };

            if (mediaFile) {
                // Processar arquivo
                const reader = new FileReader();
                reader.onload = function (e) {
                    mediaItem.data = e.target.result;
                    mediaItem.filename = mediaFile.name;
                    chapter.media.push(mediaItem);
                    updateChaptersUI();
                    logToSystem(`M√≠dia adicionada ao cap√≠tulo ${chapterId}`, 'success');
                };
                reader.readAsDataURL(mediaFile);
            } else if (mediaPrompt) {
                // Gerar m√≠dia baseada no prompt
                mediaItem.prompt = mediaPrompt;
                mediaItem.status = 'generating';
                chapter.media.push(mediaItem);

                generateMediaFromPrompt(chapterId, mediaItem.id, mediaType, mediaPrompt);
            }

            closeModal();
        }

        // Fun√ß√£o para gerar m√≠dia a partir do prompt
        async function generateMediaFromPrompt(chapterId, mediaId, mediaType, prompt) {
            try {
                logToSystem(`Gerando ${mediaType} para cap√≠tulo ${chapterId}...`, 'info');

                if (mediaType === 'chart') {
                    // Gerar dados para gr√°fico
                    const chartPrompt = `Baseado no prompt: "${prompt}"
                    
Gere dados em formato JSON para criar um gr√°fico. Inclua:
1. Tipo de gr√°fico (bar, line, pie, etc.)
2. Dados estruturados
3. Configura√ß√µes de estilo
4. T√≠tulo e labels

Formato:
{
  "type": "tipo_do_grafico",
  "title": "T√≠tulo do Gr√°fico",
  "data": { /* dados estruturados */ },
  "options": { /* configura√ß√µes */ }
}`;

                    const chartData = await callAIProvider(chartPrompt);
                    const chapter = projectChapters.find(ch => ch.id === chapterId);
                    const media = chapter.media.find(m => m.id === mediaId);

                    media.chartData = JSON.parse(chartData);
                    media.status = 'completed';

                } else if (mediaType === 'image') {
                    // Para imagens, normalmente usar√≠amos uma API como DALL-E
                    // Por enquanto, vamos simular
                    const chapter = projectChapters.find(ch => ch.id === chapterId);
                    const media = chapter.media.find(m => m.id === mediaId);

                    media.status = 'completed';
                    media.generatedPrompt = prompt;

                } else if (mediaType === 'interaction') {
                    // Gerar c√≥digo de intera√ß√£o
                    const interactionPrompt = `Crie uma intera√ß√£o educativa baseada em: "${prompt}"
                    
Gere c√≥digo HTML/CSS/JavaScript para uma intera√ß√£o que:
1. Seja educativa e engajante
2. Teste o conhecimento do usu√°rio
3. Forne√ßa feedback imediato
4. Seja responsiva

Responda apenas com o c√≥digo HTML completo.`;

                    const interactionCode = await callAIProvider(interactionPrompt);
                    const chapter = projectChapters.find(ch => ch.id === chapterId);
                    const media = chapter.media.find(m => m.id === mediaId);

                    media.interactionCode = interactionCode;
                    media.status = 'completed';
                }

                updateChaptersUI();
                logToSystem(`${mediaType} gerado com sucesso para cap√≠tulo ${chapterId}`, 'success');

            } catch (error) {
                const chapter = projectChapters.find(ch => ch.id === chapterId);
                const media = chapter.media.find(m => m.id === mediaId);
                media.status = 'error';
                media.error = error.message;

                logToSystem(`Erro ao gerar ${mediaType}: ${error.message}`, 'error');
                updateChaptersUI();
            }
        }

        // Fun√ß√µes para configura√ß√µes
        function testAIConnection() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value;

            if (!apiKey) {
                alert('Por favor, insira uma chave de API v√°lida.');
                return;
            }

            logToSystem(`Testando conex√£o com ${provider}...`, 'info');

            // Simular teste de conex√£o
            setTimeout(() => {
                const success = Math.random() > 0.3; // 70% de chance de sucesso

                if (success) {
                    logToSystem(`‚úÖ Conex√£o com ${provider} estabelecida com sucesso`, 'success');
                    systemConfig.ai.provider = provider;
                    systemConfig.ai.apiKey = apiKey;
                } else {
                    logToSystem(`‚ùå Falha na conex√£o com ${provider}`, 'error');
                }
            }, 2000);
        }

        function testAgnoConnection() {
            const endpoint = document.getElementById('agnoEndpoint').value;
            const apiKey = document.getElementById('agnoApiKey').value;

            if (!endpoint) {
                alert('Por favor, insira o endpoint do Agno.');
                return;
            }

            logToSystem('Testando conex√£o com Agno RAG...', 'info');

            // Simular teste
            setTimeout(() => {
                const success = Math.random() > 0.4;

                if (success) {
                    logToSystem('‚úÖ Conex√£o com Agno RAG estabelecida', 'success');
                    systemConfig.agno.endpoint = endpoint;
                    systemConfig.agno.apiKey = apiKey;
                } else {
                    logToSystem('‚ùå Falha na conex√£o com Agno RAG', 'error');
                }
            }, 1500);
        }

        function testCrawl4aiConnection() {
            const endpoint = document.getElementById('crawl4aiEndpoint').value;

            if (!endpoint) {
                alert('Por favor, insira o endpoint do Crawl4AI.');
                return;
            }

            logToSystem('Testando conex√£o com Crawl4AI...', 'info');

            setTimeout(() => {
                const success = Math.random() > 0.3;

                if (success) {
                    logToSystem('‚úÖ Crawl4AI conectado e funcionando', 'success');
                    systemConfig.crawl4ai.endpoint = endpoint;
                } else {
                    logToSystem('‚ùå Falha na conex√£o com Crawl4AI', 'error');
                }
            }, 1000);
        }

        function initializeRag() {
            const indexName = document.getElementById('ragIndex').value;

            if (!systemConfig.agno.endpoint || !systemConfig.agno.apiKey) {
                alert('Configure a conex√£o com Agno primeiro.');
                return;
            }

            logToSystem(`Inicializando √≠ndice RAG: ${indexName}...`, 'info');

            setTimeout(() => {
                logToSystem('‚úÖ √çndice RAG inicializado com sucesso', 'success');
                systemConfig.agno.index = indexName;
            }, 2000);
        }

        function saveSettings() {
            const settings = {
                ai: {
                    provider: document.getElementById('aiProvider').value,
                    apiKey: document.getElementById('aiApiKey').value,
                    model: document.getElementById('orModel') ? document.getElementById('orModel').value : 'gpt-4'
                },
                agno: {
                    endpoint: document.getElementById('agnoEndpoint').value,
                    apiKey: document.getElementById('agnoApiKey').value,
                    index: document.getElementById('ragIndex').value
                },
                crawl4ai: {
                    endpoint: document.getElementById('crawl4aiEndpoint').value,
                    depth: parseInt(document.getElementById('crawlDepth').value),
                    delay: parseInt(document.getElementById('crawlDelay').value)
                },
                general: {
                    maxTokens: parseInt(document.getElementById('maxTokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    language: document.getElementById('language').value
                }
            };

            localStorage.setItem('ebookGeneratorSettings', JSON.stringify(settings));
            systemConfig = settings;

            logToSystem('‚úÖ Configura√ß√µes salvas com sucesso', 'success');
            alert('Configura√ß√µes salvas!');
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('ebookGeneratorSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    systemConfig = settings;

                    // Atualizar campos da interface
                    document.getElementById('aiProvider').value = settings.ai.provider || 'openai';
                    document.getElementById('aiApiKey').value = settings.ai.apiKey || '';
                    document.getElementById('agnoEndpoint').value = settings.agno.endpoint || 'http://localhost:8000';
                    document.getElementById('agnoApiKey').value = settings.agno.apiKey || '';
                    document.getElementById('ragIndex').value = settings.agno.index || 'ebook-projects';
                    document.getElementById('crawl4aiEndpoint').value = settings.crawl4ai.endpoint || 'http://localhost:8001';
                    document.getElementById('crawlDepth').value = settings.crawl4ai.depth || 2;
                    document.getElementById('crawlDelay').value = settings.crawl4ai.delay || 1000;
                    document.getElementById('maxTokens').value = settings.general.maxTokens || 4000;
                    document.getElementById('temperature').value = settings.general.temperature || 0.7;
                    document.getElementById('language').value = settings.general.language || 'pt';

                    if (settings.ai.model && document.getElementById('orModel')) {
                        document.getElementById('orModel').value = settings.ai.model;
                    }

                    logToSystem('‚úÖ Configura√ß√µes carregadas', 'success');
                    alert('Configura√ß√µes carregadas!');
                } else {
                    logToSystem('‚ö†Ô∏è Nenhuma configura√ß√£o salva encontrada', 'warning');
                }
            } catch (error) {
                logToSystem(`‚ùå Erro ao carregar configura√ß√µes: ${error.message}`, 'error');
            }
        }

        // Fun√ß√µes para preview e delete de cap√≠tulos
        function previewChapter(chapterId) {
            const chapter = projectChapters.find(ch => ch.id === chapterId);
            if (!chapter || !chapter.content) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Preview: ${chapter.title}</h3>
                        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
                        <div id="chapterPreviewContent" style="line-height: 1.6; color: #333;">
                            ${formatMarkdownPreview(chapter.content)}
                        </div>
                    </div>

                    ${chapter.media && chapter.media.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <h4>M√≠dia Associada:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                                ${chapter.media.map(media => `
                                    <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-weight: bold; margin-bottom: 8px;">${getMediaIcon(media.type)} ${media.type.toUpperCase()}</div>
                                        <div style="font-size: 12px; color: #666;">${media.description || 'Sem descri√ß√£o'}</div>
                                        <div style="margin-top: 8px;">
                                            <span style="background: ${getStatusColor(media.status)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                                ${media.status || 'pending'}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn" onclick="exportChapter(${chapterId})">üìÑ Exportar Cap√≠tulo</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function deleteChapter(chapterId) {
            if (!confirm('Tem certeza que deseja deletar este cap√≠tulo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            const chapterIndex = projectChapters.findIndex(ch => ch.id === chapterId);
            if (chapterIndex !== -1) {
                projectChapters.splice(chapterIndex, 1);
                updateChaptersUI();
                logToSystem(`Cap√≠tulo ${chapterId} deletado`, 'info');
            }
        }

        function generateChartForChapter(chapterId) {
            const chapter = projectChapters.find(ch => ch.id === chapterId);
            if (!chapter) return;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 700px; width: 90%;">
                    <h3>Gerar Gr√°fico para Cap√≠tulo ${chapter.id}</h3>
                    
                    <div class="form-group">
                        <label>Tipo de Gr√°fico</label>
                        <select id="chartType" class="form-control">
                            <option value="bar">Gr√°fico de Barras</option>
                            <option value="line">Gr√°fico de Linhas</option>
                            <option value="pie">Gr√°fico de Pizza</option>
                            <option value="scatter">Gr√°fico de Dispers√£o</option>
                            <option value="area">Gr√°fico de √Årea</option>
                            <option value="doughnut">Gr√°fico Rosquinha</option>
                            <option value="radar">Gr√°fico Radar</option>
                            <option value="dashboard">Dashboard Completo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Dados ou Prompt para Gera√ß√£o</label>
                        <textarea id="chartData" class="form-control" rows="4" placeholder="Ex: Vendas por m√™s: Janeiro=100, Fevereiro=150, Mar√ßo=200... OU descreva que tipo de dados mostrar"></textarea>
                    </div>

                    <div class="form-group">
                        <label>T√≠tulo do Gr√°fico</label>
                        <input type="text" id="chartTitle" class="form-control" placeholder="Ex: Crescimento de Vendas 2024">
                    </div>

                    <div class="form-group">
                        <label>Contexto do Cap√≠tulo</label>
                        <textarea id="chartContext" class="form-control" rows="2" readonly>${chapter.title} - ${chapter.description}</textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="generateChartForChapterConfirm(${chapterId})">üìä Gerar Gr√°fico</button>
                        <button class="btn" onclick="closeModal()" style="background: #6c757d;">‚ùå Cancelar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        async function generateChartForChapterConfirm(chapterId) {
            const chartType = document.getElementById('chartType').value;
            const chartData = document.getElementById('chartData').value;
            const chartTitle = document.getElementById('chartTitle').value;
            const chartContext = document.getElementById('chartContext').value;

            if (!chartData || !chartTitle) {
                alert('Por favor, preencha os dados e t√≠tulo do gr√°fico.');
                return;
            }

            closeModal();

            try {
                logToSystem(`Gerando gr√°fico ${chartType} para cap√≠tulo ${chapterId}...`, 'info');

                const chartPrompt = `Gere dados estruturados para um gr√°fico ${chartType} com base nas seguintes informa√ß√µes:

T√≠tulo: ${chartTitle}
Dados/Descri√ß√£o: ${chartData}
Contexto do Cap√≠tulo: ${chartContext}

Responda APENAS com um objeto JSON v√°lido no seguinte formato:
{
  "type": "${chartType}",
  "title": "${chartTitle}",
  "data": {
    "labels": ["Label1", "Label2", ...],
    "datasets": [{
      "label": "Nome do Dataset",
      "data": [valor1, valor2, ...],
      "backgroundColor": ["#cor1", "#cor2", ...],
      "borderColor": "#cor",
      "borderWidth": 2
    }]
  },
  "options": {
    "responsive": true,
    "plugins": {
      "title": { "display": true, "text": "${chartTitle}" },
      "legend": { "display": true }
    },
    "scales": {
      "y": { "beginAtZero": true }
    }
  }
}

Para gr√°ficos de pizza/rosquinha, use apenas data e backgroundColor.
Para dashboards, crie m√∫ltiplos datasets.
Use cores profissionais e harmoniosas.`;

                const chartConfigText = await callAIProvider(chartPrompt);
                const chartConfig = JSON.parse(chartConfigText);

                // Adicionar gr√°fico ao cap√≠tulo
                const chapter = projectChapters.find(ch => ch.id === chapterId);
                if (!chapter.charts) chapter.charts = [];

                const newChart = {
                    id: Date.now(),
                    config: chartConfig,
                    createdAt: new Date().toISOString(),
                    status: 'completed'
                };

                chapter.charts.push(newChart);

                // Renderizar gr√°fico na interface
                displayChart(chapterId, newChart);

                updateChaptersUI();
                logToSystem(`Gr√°fico gerado com sucesso para cap√≠tulo ${chapterId}`, 'success');

            } catch (error) {
                logToSystem(`Erro ao gerar gr√°fico: ${error.message}`, 'error');
            }
        }

        function displayChart(chapterId, chart) {
            // Criar modal para mostrar o gr√°fico
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center;
                justify-content: center; z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; max-width: 800px; width: 95%; max-height: 80vh;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üìä ${chart.config.title}</h3>
                        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
                    </div>
                    
                    <div style="position: relative; height: 400px; margin-bottom: 20px;">
                        <canvas id="chartCanvas_${chart.id}"></canvas>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-small" onclick="downloadChart(${chart.id})">üíæ Baixar PNG</button>
                        <button class="btn btn-small" onclick="copyChartData(${chart.id})">üìã Copiar Dados</button>
                        <button class="btn btn-small" onclick="editChart(${chapterId}, ${chart.id})">‚úèÔ∏è Editar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;

            // Renderizar gr√°fico usando Chart.js (seria necess√°rio incluir a biblioteca)
            // Por enquanto, mostrar uma representa√ß√£o visual
            setTimeout(() => {
                const canvas = document.getElementById(`chartCanvas_${chart.id}`);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#667eea';
                    ctx.fillRect(50, 50, 200, 100);
                    ctx.fillStyle = '#764ba2';
                    ctx.fillRect(100, 100, 200, 100);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText(`Gr√°fico: ${chart.config.title}`, 60, 80);
                    ctx.fillText(`Tipo: ${chart.config.type}`, 60, 130);
                }
            }, 100);
        }

        // Fun√ß√µes auxiliares
        function formatMarkdownPreview(content) {
            return content
                .replace(/# (.*)/g, '<h1>$1</h1>')
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/### (.*)/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\[IMAGEM: (.*?)\]/g, '<div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; color: #1976d2;">üñºÔ∏è Imagem: $1</div>')
                .replace(/\[GR√ÅFICO: (.*?)\]/g, '<div style="background: #f3e5f5; padding: 10px; border-radius: 5px; margin: 10px 0; color: #7b1fa2;">üìä Gr√°fico: $1</div>')
                .replace(/\[INTERA√á√ÉO: (.*?)\]/g, '<div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0; color: #388e3c;">üéØ Intera√ß√£o: $1</div>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^\s*/, '<p>')
                .replace(/\s*$/, '</p>');
        }

        function getMediaIcon(type) {
            const icons = {
                image: 'üñºÔ∏è',
                chart: 'üìä',
                interaction: 'üéØ',
                video: 'üé•',
                audio: 'üéµ'
            };
            return icons[type] || 'üìÑ';
        }

        function getStatusColor(status) {
            const colors = {
                pending: '#ffa726',
                generating: '#42a5f5',
                completed: '#66bb6a',
                error: '#ef5350'
            };
            return colors[status] || '#9e9e9e';
        }

        function exportChapter(chapterId) {
            const chapter = projectChapters.find(ch => ch.id === chapterId);
            if (!chapter) return;

            const exportData = {
                title: chapter.title,
                content: chapter.content,
                media: chapter.media || [],
                charts: chapter.charts || [],
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `capitulo_${chapter.id}_${chapter.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            a.click();

            URL.revokeObjectURL(url);
            logToSystem(`Cap√≠tulo ${chapterId} exportado`, 'success');
        }

        // Fun√ß√£o de log do sistema
        function logToSystem(message, type = 'info') {
            const logsContainer = document.getElementById('systemLogs');
            const timestamp = new Date().toLocaleTimeString();
            const typeColors = {
                info: '#00ff00',
                success: '#00ff88',
                warning: '#ffaa00',
                error: '#ff4444'
            };

            const logEntry = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${typeColors[type] || '#00ff00'};">${message}</span><br>`;
            logsContainer.innerHTML += logEntry;
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Fun√ß√µes do Editor Visual
        function initVisualEditor() {
            // Carregar script do editor visual se n√£o estiver carregado
            if (!window.visualEditor) {
                const script = document.createElement('script');
                script.src = '/js/visual-editor.js';
                script.onload = () => {
                    window.visualEditor = new VisualEditor('visualEditorContainer', {
                        template: 'kindle-standard',
                        enableKindleFeatures: true
                    });
                    logToSystem('Editor visual inicializado!', 'success');
                };
                document.head.appendChild(script);
            } else {
                logToSystem('Editor visual j√° est√° ativo!', 'info');
            }
        }

        function loadChapterInEditor() {
            if (!currentProject || !projectChapters.length) {
                alert('Nenhum projeto ou cap√≠tulo dispon√≠vel para carregar.');
                return;
            }

            const chapterSelect = prompt(`Escolha um cap√≠tulo (1-${projectChapters.length}):`);
            const chapterIndex = parseInt(chapterSelect) - 1;

            if (chapterIndex >= 0 && chapterIndex < projectChapters.length) {
                const chapter = projectChapters[chapterIndex];

                if (!window.visualEditor) {
                    initVisualEditor();
                    setTimeout(() => loadChapterContent(chapter), 1000);
                } else {
                    loadChapterContent(chapter);
                }
            }
        }

        function loadChapterContent(chapter) {
            if (window.visualEditor && chapter.content) {
                // Converter conte√∫do markdown para elementos do editor
                const elements = parseMarkdownToElements(chapter.content);

                window.visualEditor.document = {
                    id: `chapter_${chapter.id}`,
                    title: chapter.title,
                    template: 'kindle-standard',
                    pages: [{
                        id: 'page_1',
                        elements: elements
                    }],
                    styles: window.visualEditor.getTemplateStyles('kindle-standard')
                };

                window.visualEditor.renderCurrentPage();
                logToSystem(`Cap√≠tulo "${chapter.title}" carregado no editor!`, 'success');
            }
        }

        function parseMarkdownToElements(markdown) {
            const elements = [];
            const lines = markdown.split('\n');
            let elementId = 1;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                if (line.startsWith('# ')) {
                    elements.push({
                        id: `el_${elementId++}`,
                        type: 'heading',
                        level: 1,
                        content: line.substring(2),
                        styles: { fontSize: '24px', fontWeight: 'bold', marginBottom: '20px' }
                    });
                } else if (line.startsWith('## ')) {
                    elements.push({
                        id: `el_${elementId++}`,
                        type: 'heading',
                        level: 2,
                        content: line.substring(3),
                        styles: { fontSize: '20px', fontWeight: 'bold', marginBottom: '15px' }
                    });
                } else if (line.startsWith('### ')) {
                    elements.push({
                        id: `el_${elementId++}`,
                        type: 'heading',
                        level: 3,
                        content: line.substring(4),
                        styles: { fontSize: '18px', fontWeight: 'bold', marginBottom: '12px' }
                    });
                } else {
                    elements.push({
                        id: `el_${elementId++}`,
                        type: 'paragraph',
                        content: line,
                        styles: { fontSize: '14px', lineHeight: '1.4', marginBottom: '10px', textAlign: 'justify' }
                    });
                }
            }

            return elements;
        }

        function showKindleInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h2 style="color: #ff9500; margin-bottom: 20px;">üì± Arquivo Kindle Exportado!</h2>
                    
                    <h3>üìã Pr√≥ximos Passos:</h3>
                    <ol style="line-height: 1.6; margin-bottom: 20px;">
                        <li><strong>Kindle Direct Publishing (KDP):</strong><br>
                            Acesse <a href="https://kdp.amazon.com" target="_blank">kdp.amazon.com</a> e fa√ßa upload do arquivo</li>
                        <li><strong>Kindle Previewer:</strong><br>
                            Baixe o Kindle Previewer para testar em diferentes dispositivos</li>
                        <li><strong>Kindle Create:</strong><br>
                            Use o Kindle Create para ajustes finais de formata√ß√£o</li>
                    </ol>

                    <h3>‚ú® Recursos Inclu√≠dos:</h3>
                    <ul style="line-height: 1.6; margin-bottom: 20px;">
                        <li>‚úÖ Formata√ß√£o otimizada para Kindle</li>
                        <li>‚úÖ Navega√ß√£o por cap√≠tulos</li>
                        <li>‚úÖ Imagens comprimidas</li>
                        <li>‚úÖ Fontes otimizadas</li>
                        <li>‚úÖ Compatibilidade com todos os dispositivos Kindle</li>
                    </ul>

                    <div style="text-align: center;">
                        <button onclick="this.closest('div').parentElement.remove()" 
                                style="background: #ff9500; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            Entendi!
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function exportToDesignTool(tool) {
            if (!currentProject) {
                alert('Nenhum projeto carregado.');
                return;
            }

            const instructions = {
                'indesign': {
                    name: 'Adobe InDesign',
                    steps: [
                        'Exporte seu projeto como PDF ou DOCX',
                        'Abra o Adobe InDesign',
                        'Use "Arquivo > Inserir" para importar o conte√∫do',
                        'Aplique templates profissionais do InDesign',
                        'Exporte como PDF para impress√£o ou EPUB para digital'
                    ]
                },
                'canva': {
                    name: 'Canva',
                    steps: [
                        'Acesse canva.com e crie uma conta',
                        'Escolha "E-book" nos templates',
                        'Copie e cole o conte√∫do do seu projeto',
                        'Use os elementos visuais do Canva',
                        'Baixe como PDF ou PNG'
                    ]
                },
                'affinity': {
                    name: 'Affinity Publisher',
                    steps: [
                        'Exporte seu projeto como DOCX',
                        'Abra o Affinity Publisher',
                        'Importe o arquivo DOCX',
                        'Aplique estilos profissionais',
                        'Exporte como PDF ou EPUB'
                    ]
                }
            };

            const toolInfo = instructions[tool];
            if (toolInfo) {
                alert(`Integra√ß√£o com ${toolInfo.name}:\n\n${toolInfo.steps.map((step, i) => `${i + 1}. ${step}`).join('\n')}`);
            }
        }

        function exportToPlatform(platform) {
            const platforms = {
                'lovble': 'Lovble - Plataforma de cursos online',
                'cursor': 'Cursor - Editor de c√≥digo com IA',
                'kdp': 'Kindle Direct Publishing'
            };

            if (platform === 'kdp') {
                window.open('https://kdp.amazon.com', '_blank');
                alert('Redirecionando para o Kindle Direct Publishing. Use a exporta√ß√£o Kindle para fazer upload do seu e-book.');
            } else {
                alert(`Integra√ß√£o com ${platforms[platform] || platform} ser√° implementada em breve!`);
            }
        }

        function showPreview(format) {
            if (!currentProject) {
                alert('Nenhum projeto carregado.');
                return;
            }

            const previewContainer = document.getElementById('projectPreview');

            switch (format) {
                case 'kindle':
                    previewContainer.innerHTML = generateKindlePreview();
                    break;
                case 'pdf':
                    previewContainer.innerHTML = generatePDFPreview();
                    break;
                case 'web':
                    previewContainer.innerHTML = generateWebPreview();
                    break;
            }
        }

        function generateKindlePreview() {
            if (!currentProject) return '<p>Nenhum projeto carregado</p>';

            return `
                <div style="max-width: 300px; margin: 0 auto; background: #000; color: #fff; padding: 20px; border-radius: 8px; font-family: 'Georgia', serif;">
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 18px;">${currentProject.title}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #ccc;">Preview Kindle</p>
                    </div>
                    
                    <div style="font-size: 14px; line-height: 1.4;">
                        ${projectChapters.slice(0, 3).map((chapter, index) => `
                            <div style="margin-bottom: 15px;">
                                <h4 style="font-size: 16px; margin: 0 0 8px 0;">Cap√≠tulo ${index + 1}: ${chapter.title}</h4>
                                <p style="margin: 0; color: #ddd; font-size: 13px;">
                                    ${chapter.description || 'Descri√ß√£o do cap√≠tulo...'}
                                </p>
                            </div>
                        `).join('')}
                        
                        ${projectChapters.length > 3 ? `<p style="text-align: center; color: #888; font-style: italic;">... e mais ${projectChapters.length - 3} cap√≠tulos</p>` : ''}
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                        <small style="color: #888;">Simula√ß√£o de dispositivo Kindle</small>
                    </div>
                </div>
            `;
        }

        function generatePDFPreview() {
            if (!currentProject) return '<p>Nenhum projeto carregado</p>';

            return `
                <div style="max-width: 400px; margin: 0 auto; background: white; border: 1px solid #ddd; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="background: #f8f9fa; padding: 20px; text-align: center; border-bottom: 1px solid #ddd;">
                        <h3 style="margin: 0; color: #333;">${currentProject.title}</h3>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Preview PDF</p>
                    </div>
                    
                    <div style="padding: 20px; font-family: 'Georgia', serif; font-size: 12px; line-height: 1.6;">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">√çndice</h4>
                        ${projectChapters.map((chapter, index) => `
                            <div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                                <span>Cap√≠tulo ${index + 1}: ${chapter.title}</span>
                                <span style="color: #666;">${index + 2}</span>
                            </div>
                        `).join('')}
                        
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                        
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Cap√≠tulo 1: ${projectChapters[0]?.title || 'Primeiro Cap√≠tulo'}</h4>
                        <p style="margin: 0; text-align: justify; color: #333;">
                            ${projectChapters[0]?.description || 'Conte√∫do do primeiro cap√≠tulo apareceria aqui com formata√ß√£o profissional, margens adequadas e tipografia otimizada para leitura...'}
                        </p>
                    </div>
                    
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-top: 1px solid #ddd;">
                        <small style="color: #888;">P√°gina 1 de ${projectChapters.length + 1}</small>
                    </div>
                </div>
            `;
        }

        function generateWebPreview() {
            if (!currentProject) return '<p>Nenhum projeto carregado</p>';

            return `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <header style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0; font-size: 28px;">${currentProject.title}</h1>
                        <p style="margin: 10px 0 0 0; opacity: 0.9;">${currentProject.description}</p>
                    </header>
                    
                    <nav style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Cap√≠tulos</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${projectChapters.map((chapter, index) => `
                                <span style="background: #e9ecef; padding: 5px 10px; border-radius: 15px; font-size: 12px; color: #495057;">
                                    ${index + 1}. ${chapter.title}
                                </span>
                            `).join('')}
                        </div>
                    </nav>
                    
                    <main style="padding: 30px 20px; background: white;">
                        <article>
                            <h2 style="color: #2c3e50; margin: 0 0 15px 0;">Cap√≠tulo 1: ${projectChapters[0]?.title || 'Primeiro Cap√≠tulo'}</h2>
                            <p style="color: #6c757d; font-style: italic; margin: 0 0 20px 0;">
                                ${projectChapters[0]?.description || 'Descri√ß√£o do cap√≠tulo'}
                            </p>
                            <div style="line-height: 1.6; color: #495057;">
                                ${projectChapters[0]?.content ?
                    projectChapters[0].content.substring(0, 300) + '...' :
                    'O conte√∫do do cap√≠tulo apareceria aqui com formata√ß√£o web responsiva, otimizada para leitura em diferentes dispositivos...'
                }
                            </div>
                        </article>
                    </main>
                    
                    <footer style="text-align: center; padding: 20px; background: #f8f9fa; color: #6c757d; border-radius: 0 0 8px 8px;">
                        <small>Preview Web - Vers√£o Responsiva</small>
                    </footer>
                </div>
            `;
        }

        // Event listeners para configura√ß√µes
        document.addEventListener('DOMContentLoaded', function () {
            // Carregar configura√ß√µes salvas
            loadSettings();

            // Listener para mudan√ßa de provedor de IA
            document.getElementById('aiProvider').addEventListener('change', function () {
                const provider = this.value;
                const openrouterModel = document.getElementById('openrouterModel');

                if (provider === 'openrouter') {
                    openrouterModel.style.display = 'block';
                } else {
                    openrouterModel.style.display = 'none';
                }
            });

            // Auto-save das configura√ß√µes
            const configInputs = ['aiProvider', 'aiApiKey', 'agnoEndpoint', 'agnoApiKey', 'ragIndex',
                'crawl4aiEndpoint', 'crawlDepth', 'crawlDelay', 'maxTokens', 'temperature', 'language'];

            configInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('change', function () {
                        logToSystem(`Configura√ß√£o ${inputId} alterada`, 'info');
                    });
                }
            });

            logToSystem('Sistema inicializado e pronto para uso', 'success');
        });

        // Simular um projeto exemplo para demonstra√ß√£o
        function loadExampleProject() {
            currentProject = {
                title: "Curso Completo de Marketing Digital",
                type: "course",
                topic: "Marketing Digital",
                description: "Um curso abrangente sobre estrat√©gias de marketing digital",
                audience: "intermediate"
            };

            projectChapters = [
                {
                    id: 1,
                    title: "Fundamentos do Marketing Digital",
                    description: "Introdu√ß√£o aos conceitos b√°sicos e evolu√ß√£o do marketing digital",
                    topics: ["Hist√≥ria do marketing digital", "Principais canais", "M√©tricas importantes"],
                    learningObjectives: ["Entender a evolu√ß√£o do marketing", "Identificar canais principais", "Conhecer m√©tricas b√°sicas"],
                    suggestedMedia: {
                        images: ["Timeline da evolu√ß√£o do marketing", "Infogr√°fico dos canais digitais"],
                        charts: ["Crescimento do marketing digital", "ROI por canal"],
                        interactions: ["Quiz sobre conceitos b√°sicos", "Calculadora de ROI"]
                    },
                    status: "completed",
                    content: "# Fundamentos do Marketing Digital\n\nO marketing digital revolucionou a forma como as empresas se conectam com seus clientes...",
                    media: []
                },
                {
                    id: 2,
                    title: "SEO e Marketing de Conte√∫do",
                    description: "Estrat√©gias para otimiza√ß√£o de mecanismos de busca e cria√ß√£o de conte√∫do relevante",
                    topics: ["SEO t√©cnico", "Pesquisa de palavras-chave", "Estrat√©gia de conte√∫do"],
                    learningObjectives: ["Dominar t√©cnicas de SEO", "Criar estrat√©gias de conte√∫do", "Medir resultados org√¢nicos"],
                    suggestedMedia: {
                        images: ["Estrutura de uma p√°gina otimizada", "Ferramentas de SEO"],
                        charts: ["Ranking de fatores SEO", "Performance org√¢nica"],
                        interactions: ["An√°lise de palavra-chave", "Auditoria SEO"]
                    },
                    status: "pending"
                }
            ];

            updateChaptersUI();
            logToSystem('Projeto exemplo carregado para demonstra√ß√£o', 'info');
        }

        // Fun√ß√µes de exporta√ß√£o
        async function exportProject(format) {
            if (!currentProject || !projectChapters.length) {
                alert('Nenhum projeto dispon√≠vel para exportar. Crie um projeto primeiro.');
                return;
            }

            logToSystem(`Iniciando exporta√ß√£o em formato ${format}...`, 'info');

            try {
                let exportData;
                let filename;
                let mimeType;

                switch (format) {
                    case 'pdf':
                        exportData = await generatePDF();
                        filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
                        mimeType = 'application/pdf';
                        break;

                    case 'epub':
                        exportData = await generateEPUB();
                        filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.epub`;
                        mimeType = 'application/epub+zip';
                        break;

                    case 'docx':
                        exportData = await generateDOCX();
                        filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.docx`;
                        mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        break;

                    case 'scorm':
                        exportData = await generateSCORM();
                        filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_scorm.zip`;
                        mimeType = 'application/zip';
                        break;

                    case 'html':
                        exportData = await generateHTMLSite();
                        filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_site.zip`;
                        mimeType = 'application/zip';
                        break;

                    case 'json':
                        exportData = generateJSON();
                        filename = `${currentProject.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                        mimeType = 'application/json';
                        break;

                    default:
                        throw new Error(`Formato ${format} n√£o suportado`);
                }

                // Download do arquivo
                const blob = new Blob([exportData], { type: mimeType });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();

                URL.revokeObjectURL(url);

                logToSystem(`‚úÖ Projeto exportado com sucesso em ${format.toUpperCase()}`, 'success');
                updateProjectPreview(format, exportData);

            } catch (error) {
                logToSystem(`‚ùå Erro na exporta√ß√£o: ${error.message}`, 'error');
                alert(`Erro ao exportar: ${error.message}`);
            }
        }

        // Geradores espec√≠ficos de formato
        function generateJSON() {
            return JSON.stringify({
                project: currentProject,
                chapters: projectChapters,
                exportInfo: {
                    format: 'json',
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                }
            }, null, 2);
        }

        async function generatePDF() {
            // Simula√ß√£o - em produ√ß√£o usaria jsPDF ou similar
            let pdfContent = `Projeto: ${currentProject.title}\n\n`;
            pdfContent += `Descri√ß√£o: ${currentProject.description}\n\n`;

            projectChapters.forEach(chapter => {
                if (chapter.content) {
                    pdfContent += `\nCap√≠tulo ${chapter.id}: ${chapter.title}\n`;
                    pdfContent += '='.repeat(50) + '\n';
                    pdfContent += chapter.content.replace(/[#*]/g, '') + '\n\n';
                }
            });

            return pdfContent;
        }

        async function generateEPUB() {
            // Estrutura b√°sica EPUB
            const epubStructure = {
                'META-INF/container.xml': `<?xml version="1.0"?>
                <container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
                  <rootfiles>
                    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
                  </rootfiles>
                </container>`,

                'OEBPS/content.opf': generateOPF(),
                'OEBPS/toc.ncx': generateNCX(),
                'OEBPS/stylesheet.css': generateEPUBCSS(),
                'OEBPS/title.html': generateTitlePage(),
                ...generateChapterHTML()
            };

            return JSON.stringify(epubStructure, null, 2);
        }

        function generateOPF() {
            return `<?xml version="1.0" encoding="UTF-8"?>
            <package version="2.0" xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId">
              <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
                <dc:title>${currentProject.title}</dc:title>
                <dc:creator>Gerador de E-books IA</dc:creator>
                <dc:language>pt</dc:language>
                <dc:date>${new Date().toISOString().split('T')[0]}</dc:date>
                <meta name="cover" content="cover-image"/>
              </metadata>
              <manifest>
                <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
                <item id="stylesheet" href="stylesheet.css" media-type="text/css"/>
                <item id="title" href="title.html" media-type="application/xhtml+xml"/>
                ${projectChapters.map(ch => `<item id="chapter${ch.id}" href="chapter${c
h.id}.html" media-type="application/xhtml+xml"/>`).join('\n                ')}
              </manifest>
              <spine toc="ncx">
                <itemref idref="title"/>
                ${projectChapters.map(ch => `<itemref idref="chapter${ch.id}"/>`).join('\n                ')}
              </spine>
            </package>`;
        }

        function generateNCX() {
            return `<?xml version="1.0" encoding="UTF-8"?>
            <ncx version="2005-1" xmlns="http://www.daisy.org/z3986/2005/ncx/">
              <head>
                <meta name="dtb:uid" content="BookId"/>
                <meta name="dtb:depth" content="1"/>
                <meta name="dtb:totalPageCount" content="0"/>
                <meta name="dtb:maxPageNumber" content="0"/>
              </head>
              <docTitle><text>${currentProject.title}</text></docTitle>
              <navMap>
                ${projectChapters.map((ch, index) => `
                <navPoint id="chapter${ch.id}" playOrder="${index + 1}">
                  <navLabel><text>${ch.title}</text></navLabel>
                  <content src="chapter${ch.id}.html"/>
                </navPoint>`).join('')}
              </navMap>
            </ncx>`;
        }

        function generateEPUBCSS() {
            return `
            body {
                font-family: Georgia, serif;
                line-height: 1.6;
                margin: 0;
                padding: 20px;
            }
            h1, h2, h3 {
                color: #333;
                page-break-after: avoid;
            }
            p {
                text-align: justify;
                margin-bottom: 1em;
            }
            .chapter {
                page-break-before: always;
            }
            `;
        }

        function generateTitlePage() {
            return `<?xml version="1.0" encoding="UTF-8"?>
            <html xmlns="http://www.w3.org/1999/xhtml">
            <head>
                <title>${currentProject.title}</title>
                <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
            </head>
            <body>
                <div style="text-align: center; margin-top: 100px;">
                    <h1>${currentProject.title}</h1>
                    <p>${currentProject.description}</p>
                    <p>Gerado por IA</p>
                </div>
            </body>
            </html>`;
        }

        function generateChapterHTML() {
            const chapters = {};
            projectChapters.forEach(chapter => {
                chapters[`OEBPS/chapter${chapter.id}.html`] = `<?xml version="1.0" encoding="UTF-8"?>
                <html xmlns="http://www.w3.org/1999/xhtml">
                <head>
                    <title>${chapter.title}</title>
                    <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
                </head>
                <body>
                    <div class="chapter">
                        <h1>${chapter.title}</h1>
                        ${chapter.content ? convertMarkdownToHTML(chapter.content) : '<p>Conte√∫do n√£o gerado ainda.</p>'}
                    </div>
                </body>
                </html>`;
            });
            return chapters;
        }

        // Carregar configura√ß√µes ao inicializar
        document.addEventListener('DOMContentLoaded', function () {
            // Verificar abas
            checkTabs();
            
            // Carregar configura√ß√µes salvas
            loadSettings();
            
            // Carregar script do editor visual
            const script = document.createElement('script');
            script.src = '/js/visual-editor.js';
            document.head.appendChild(script);
            
            logToSystem('Sistema inicializado!', 'success');
        });
    </script>
</body>
</html>